# 🛒 Amazon 検索順位自動取得ツール（Search Rank Tracker）

本ツールは、**Amazon上での自社商品の検索順位を自動的にチェック**し、  
オーガニック検索・スポンサー広告枠（SP／SB）を含めてデータを取得する  
Pythonベースのスクレイピングシステムです。

---

## 🚀 主な機能

### 1. シークレットモードでの検索実行
- ブラウザキャッシュや検索履歴の影響を排除するため、**Chromeのシークレットモード**で実行します。  
- 実際のユーザー検索に近い状態で順位を取得できます。

### 2. 取得対象

| 種別 | 説明 |
|------|------|
| オーガニック | 自然検索で表示される商品 |
| SP（スポンサー・プロダクト） | 商品リスティング内の広告（Sponsored Products） |
| SB（スポンサー・ブランド） | ページ上部に表示されるブランド広告（Sponsored Brands） |

### 3. 設定項目
- **SKU**：複数登録可能（例：ASINや社内管理コード）  
- **キーワード**：複数登録可能（運用で追加可能）  
- **検索対象国・言語**：`amazon.co.jp` など指定可能  

### 4. 出力フォーマット

| キーワード | 種別 | SKU | 順位 | ページURL | 取得日時 |
|-------------|------|------|------|------------|----------|
| インドアゴルフ | オーガニック | ASIN12345 | 3 | https://www.amazon.co.jp/... | 2025-11-07 12:00 |

出力は **CSV** または **Googleスプレッドシート**（オプション）に対応しています。

---

## ⚙️ 使用技術

- **Python 3.x**  
- **Selenium**（ブラウザ操作・シークレットモード制御）  
- **BeautifulSoup4 / lxml**（HTML解析）  
- **Pandas**（データ整形・出力）  
- **Chrome WebDriver**（Chromium系ブラウザ用）

---

## 🧩 システム構成（視覚化）

以下のフローをそのまま README に貼ってもレイアウトが崩れないよう、**コードブロック**で表示しています。

```
+---------------------------+
| keywords.csv, asins.csv  |
+-------------+-------------+
         ↓
    [Playwright]
         ↓
Amazon検索（シークレットモード）
         ↓
    HTML解析
         ↓
順位・広告種別を抽出
         ↓
   結果データ
         ↓
Google Sheets 出力
```

---

## 📋 必要な環境

- **Python 3.9以上**
- **Googleアカウント**（スプレッドシートへの書き込み用）
- **インターネット接続**

---

## 🔧 セットアップ

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd Amazon-Ranking-Scraping-myself-
```

### 2. 依存パッケージのインストール

```bash
pip install -r requirements.txt
```

または個別にインストール：

```bash
pip install playwright google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib python-dotenv
```

### 3. Playwrightブラウザのインストール

```bash
playwright install chromium
```

### 4. 設定ファイルの準備

#### `.env`ファイルの作成

プロジェクトルートに`.env`ファイルを作成し、以下の内容を設定：

```env
TARGET_URL=https://www.amazon.co.jp/?language=ja_JP
ASINS_FILE=asins.csv
KEYWORDS_FILE=keywords.csv
```

#### `asins.csv`の作成

対象商品のASINを1行に1つずつ記入：

```csv
B08XXXXXXX
B09YYYYYYY
```

#### `keywords.csv`の作成

検索キーワードを1行に1つずつ記入：

```csv
生ゴミ処理機
キーワード2
キーワード3
```

#### `spreadsheetIDs.csv`の作成

GoogleスプレッドシートのIDを1行に1つずつ記入：

```csv
1YBeUTW7sMpmls4KOD0sNcxHJah8WuAe9YlDQCvDCE6Q
```

### 5. Google Sheets APIの設定

1. **Google Cloud Console**でプロジェクトを作成
2. **Google Sheets API**を有効化
3. **サービスアカウント**を作成
4. **JSONキー**をダウンロード
5. JSONキーファイルを`weighty-vertex-464012-u4-7cd9bab1166b.json`としてプロジェクトルートに配置
6. スプレッドシートをサービスアカウントのメールアドレスと共有（編集権限を付与）

---

## 🎯 使用方法

### GUIアプリケーションの起動

```bash
python app.py
```

### 操作手順

1. **スプレッドシートIDを選択**
   - ドロップダウンからスプレッドシートIDを選択
   - 自動的にシート一覧が取得されます

2. **シートを選択**
   - ドロップダウンから対象のシートを選択

3. **開始ボタンをクリック**
   - スクレイピングが開始されます
   - 実行中はボタンが無効化されます
   - ログエリアに進捗が表示されます

4. **結果の確認**
   - スクレイピング完了後、自動的にスプレッドシートに結果が書き込まれます
   - 同じ日付の行が存在する場合は上書きされます

---

## 📊 スプレッドシートの構造

### ヘッダー（2行）

**行1**: `日付/キーワード` | `自然検索` | 空列 | ... | `SP` | 空列 | ... | `SB` | 空列 | ...

**行2**: 空 | `キーワード1` | `キーワード2` | ... | `キーワード1` | `キーワード2` | ... | `キーワード1` | `キーワード2` | ...

### データ行（行3以降）

| 日付 | 自然検索結果1 | 自然検索結果2 | ... | SP結果1 | SP結果2 | ... | SB結果1 | SB結果2 | ... |
|------|--------------|--------------|-----|---------|---------|-----|---------|---------|-----|
| 09/17 | 8 | - | ... | 2 | - | ... | 2 | - | ... |

- **日付形式**: `MM/DD`（例：`09/17`）
- **結果データがない場合**: `-`で表示
- **順位**: 1ページ目の場合は数値、2ページ目以降は`2ページ目`と表示

---

## 🔍 機能詳細

### ヘッダー自動検証

- 既存のヘッダー構造を検証
- 不一致の場合はシート全体をクリアしてヘッダーを再設定
- キーワード数に応じて動的に列数を調整

### データ管理

- **日付ベースの行管理**: 同じ日付の行が存在する場合は上書き
- **新規追加**: 新しい日付の場合は行を追加
- **キーワードマッチング**: BOM文字を自動除去して正確にマッチング

---

## 🛠️ トラブルシューティング

### エラー: 認証ファイルが見つかりません

- `weighty-vertex-464012-u4-7cd9bab1166b.json`がプロジェクトルートに存在するか確認
- ファイル名が正確か確認

### エラー: スプレッドシートへのアクセス権限がありません

- スプレッドシートをサービスアカウントのメールアドレスと共有しているか確認
- 編集権限が付与されているか確認

### エラー: scrap.py が見つかりません

- `scrap.py`がプロジェクトルートに存在するか確認
- ファイル名が正確か確認

### スクレイピングがタイムアウトする

- インターネット接続を確認
- Amazonのレート制限に引っかかっている可能性があります（しばらく待ってから再試行）

### 結果がスプレッドシートに反映されない

- キーワードのBOM文字を確認
- `keywords.csv`と`scrap.py`の出力でキーワードが一致しているか確認
- ログを確認してエラーメッセージがないか確認

---

## 📝 注意事項

- **レート制限**: Amazonのレート制限に注意してください。過度なリクエストはIPアドレスのブロックにつながる可能性があります
- **利用規約**: Amazonの利用規約を遵守してください
- **データのバックアップ**: 重要なデータは定期的にバックアップしてください

---

## 📄 ライセンス

このプロジェクトのライセンス情報を記載してください。

---

## 🤝 貢献

プルリクエストやイシューの報告を歓迎します。

---

## 📧 サポート

問題が発生した場合は、GitHubのIssuesで報告してください。
